---
title: Go 并发模式：管道与取消
date: 2024-12-12
lastmod: 2024-12-22
tags: ['Go']
draft: false
summary: Go 语言的并发特性让我们能够构建高效的流式数据管道 (streaming data pipelines)，通过使用通道 (channels) 连接各个处理阶段，实现诸如数字平方运算等操作，并通过显式的取消信号 (cancellation signals) 来有效处理故障和管理系统资源。
---

## 简介

Go 语言的并发原语让构建高效利用 I/O 和多 CPU 的流式数据管道变得简单。本文将通过示例介绍这类管道，重点说明操作失败时出现的细节问题，并介绍如何优雅地处理这些失败情况。

## 什么是管道？

Go 语言中没有管道 (pipeline) 的正式定义，它只是众多并发程序中的一种。简单来说，管道是由多个通过通道 (channel) 连接的阶段 (stage) 组成，每个阶段都是一组运行相同函数的 goroutine。在每个阶段中，goroutine 会：

- 通过入站通道 (inbound channel) 从上游 (upstream) 接收数据
- 对数据进行处理，通常会产生新的值
- 通过出站通道 (outbound channel) 向下游 (downstream) 发送数据

每个阶段可以有任意数量的入站和出站通道，但第一个和最后一个阶段例外：第一个阶段只有出站通道，最后一个阶段只有入站通道。第一个阶段通常被称为源 (source) 或生产者 (producer)；最后一个阶段被称为汇 (sink) 或消费者 (consumer)。

我们先用一个简单的管道示例来解释这些概念和技巧，之后再介绍一个更实用的例子。

## 数字平方运算

让我们来看一个包含三个阶段的管道。

第一个阶段是 `gen` 函数，它将整数列表转换为一个能发送这些整数的通道。`gen` 函数会启动一个 goroutine，将整数发送到通道中，并在所有值发送完毕后关闭通道：
